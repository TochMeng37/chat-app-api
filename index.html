<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>1-on-1 Chat App</title>
<style>
  body { font-family: Arial; max-width: 600px; margin: 20px auto; }
  #chatBox { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
  #chatBox p { margin: 5px 0; }
  #messageInput { width: 80%; padding: 5px; }
  #sendBtn { padding: 5px 10px; }
</style>
</head>
<body>

<h2>1-on-1 Chat App</h2>

<label>JWT Token:</label><br>
<input type="text" id="tokenInput" style="width: 100%;" placeholder="Paste your JWT token here"><br><br>

<label>Chat with (username):</label><br>
<input type="text" id="withUser" placeholder="Enter recipient username"><br><br>

<button id="connectBtn">Connect</button><br><br>

<div id="chatBox"></div>

<input type="text" id="messageInput" placeholder="Type a message...">
<button id="sendBtn">Send</button>

<script>
let ws;
let token, withUser;

const chatBox = document.getElementById("chatBox");

function addMessage(text) {
    const p = document.createElement("p");
    p.textContent = text;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
}

document.getElementById("connectBtn").onclick = async () => {
    token = document.getElementById("tokenInput").value.trim();
    withUser = document.getElementById("withUser").value.trim();

    if(!token || !withUser) {
        alert("Please enter JWT token and recipient username");
        return;
    }

    // Load chat history
    let history = [];
    try {
        const res = await fetch(`http://localhost:5000/chat/history?with=${withUser}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        history = await res.json();
        if(!Array.isArray(history)) history = [];
    } catch (err) {
        console.error("Failed to load chat history:", err);
        alert("Failed to load chat history");
        history = [];
    }

    chatBox.innerHTML = "";
    history.forEach(msg => {
        const text = msg.sender === withUser ? `${msg.sender}: ${msg.content}` : `You: ${msg.content}`;
        addMessage(text);
    });

    // Open WebSocket
    ws = new WebSocket(`ws://localhost:5000/ws?token=${token}`);
    ws.onopen = () => addMessage("✅ Connected to WebSocket");
    ws.onclose = () => addMessage("⚠️ Disconnected from WebSocket");
    ws.onerror = (e) => console.error("WebSocket error:", e);

    ws.onmessage = e => {
        try {
            const msg = JSON.parse(e.data);
            // Show only if message is from or to the current chat partner
            if(msg.from === withUser || msg.from === msg.to) {
                addMessage(`${msg.from}: ${msg.message}`);
            }
        } catch (err) {
            console.error("Failed to parse WS message:", err);
        }
    };
};

document.getElementById("sendBtn").onclick = () => {
    const content = document.getElementById("messageInput").value.trim();
    if(!content || !ws) return;

    const msg = { to: withUser, message: content };
    ws.send(JSON.stringify(msg));
    addMessage(`You: ${content}`);
    document.getElementById("messageInput").value = "";
};
</script>

</body>
</html>
